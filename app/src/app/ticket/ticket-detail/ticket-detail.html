@if(ticket()) {
<div class="detail-container">
    <mat-card class="detail-card">

        <!-- ENCABEZADO -->
        <div class="detail-header">
            <div class="avatar">{{ ticket()?.titulo?.charAt(0) || '?' }}</div>
            <div class="info">
                <h2>{{ ticket()?.titulo }}</h2>
                <div class="estado-badge">
                    <span class="badge" [ngClass]="ticket()?.status?.toLowerCase()">
                        {{ ticket()?.status }}
                    </span>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- INFORMACIÓN GENERAL -->
        <div class="detail-body">
            <p><strong>Descripción:</strong> {{ ticket()?.descripcion }}</p>
            <p><strong>Fecha de creación:</strong> {{ ticket()?.createdAt | date:'medium' }}</p>
            <p><strong>Solicitante:</strong> {{ ticket()?.solicitante?.nombre }}</p>
            <p><strong>Categoría:</strong> {{ ticket()?.categoria?.nombre }}</p>
            <p><strong>Prioridad:</strong> {{ ticket()?.categoria?.sla?.prioridad }}</p>
        </div>

        <div class="divider"></div>

        <!-- SLA Y CUMPLIMIENTO -->
        <div class="sla-section">
            <p><strong>Días de resolución:</strong> {{ ticket()?.diasResolucion }}</p>
            <p><strong>SLA de Respuesta:</strong> {{ ticket()?.categoria?.sla?.maxRespuestaHrs }} hora(s)</p>
            <p><strong>SLA de Resolución:</strong> {{ ticket()?.categoria?.sla?.maxResolucionHrs }} hora(s)</p>
        </div>

        <div class="cumplimiento-section">
            <p>
                <strong>Cumplimiento de respuesta:</strong>
                <span [ngClass]="
            ticket()?.cumplioRespuesta === true ? 'cumple' :
            ticket()?.cumplioRespuesta === false ? 'no-cumple' : 'sin-dato'">
                    {{ ticket()?.cumplioRespuesta === true ? '✔️ Cumplido' :
                    ticket()?.cumplioRespuesta === false ? 'No cumplido' : 'No disponible' }}
                </span>
            </p>

            <p>
                <strong>Cumplimiento de resolución:</strong>
                <span [ngClass]="
            ticket()?.cumplioResolucion === true ? 'cumple' :
            ticket()?.cumplioResolucion === false ? 'no-cumple' : 'sin-dato'">
                    {{ ticket()?.cumplioResolucion === true ? '✔️ Cumplido' :
                    ticket()?.cumplioResolucion === false ? 'No cumplido' : 'No disponible' }}
                </span>
            </p>
        </div>

        <!-- HISTORIAL DE ESTADOS -->
        <section class="historial-section">
            <h3>Historial de estados</h3>

            @if (ticket()?.historial?.length) {
            <div class="historial-list">
                @for (item of ticket()?.historial; track item.id) {
                <div class="historial-item">
                    <div class="historial-header">
                        <span class="estado">
                            {{ item.fromStatus || 'Inicio' }} → <strong>{{ item.toStatus }}</strong>
                        </span>
                        <span class="fecha">{{ item.createdAt | date:'medium' }}</span>
                    </div>

                    <p class="nota">
                        <strong>Observación:</strong> {{ item.nota || 'Sin observación' }}
                    </p>

                    <p class="actor">
                        <strong>Registrado por:</strong> {{ item.actor?.nombre || 'Desconocido' }}
                    </p>

                    @if (item.imagenes?.length) {
                    <div class="imagenes">
                        @for (img of item.imagenes; track img.id) {
                        <img [src]="'http://localhost:3000/images/' + img.url" alt="Evidencia" class="evidencia-img" />
                        }
                    </div>
                    }
                </div>
                }
            </div>
            } @else {
            <p class="sin-historial">No hay historial registrado para este ticket.</p>
            }
        </section>


        <!-- VALORACIÓN DEL SERVICIO (solo lectura) -->
        @if (ticket()?.status === 'CLOSED') {
        <section class="valoracion-section">
            <h3>Valoración del servicio</h3>

            @if (valoracion) {
            <div class="valoracion-existente">
                <p><strong>Puntaje:</strong></p>
                <div class="stars">
                    @for (i of [1, 2, 3, 4, 5]; track i) {
                    <mat-icon [class.active]="i <= valoracion.puntaje">star</mat-icon>
                    }
                </div>
                <p><strong>Comentario:</strong> {{ valoracion.comentario || 'Sin comentario' }}</p>
                <p class="fecha">Registrado el {{ valoracion.createdAt | date:'medium' }}</p>
            </div>
            } @else {
            <p class="sin-valoracion">Este ticket no tiene valoración registrada.</p>
            }
        </section>
        }

        <!-- PIE -->
        <div class="detail-footer">
            <button mat-stroked-button color="accent" (click)="goBack()">Regresar</button>
        </div>

    </mat-card>
</div>
} @else {
<mat-card-content>
    <p class="mat-body text">Ticket no encontrado</p>
</mat-card-content>
}